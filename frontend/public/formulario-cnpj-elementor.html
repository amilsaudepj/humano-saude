<!-- FORMULÁRIO CNPJ - HTML+JS PURO (Elementor / qualquer página) -->
<!-- Cole este bloco onde quiser. Para Next.js use a URL da sua API: /api/consulta-cnpj -->
<!-- Em site estático ou outro domínio, use um proxy ou CORS-friendly API -->

<div class="cnpj-form-container" style="max-width: 480px; margin: 0 auto; padding: 24px; background: #fff; border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
  <h2 style="margin: 0 0 8px 0; font-size: 1.5rem;">Consulta CNPJ</h2>
  <p style="margin: 0 0 20px 0; color: #666; font-size: 0.875rem;">Digite 14 dígitos. Razão social, fantasia e cidade preenchem automaticamente.</p>

  <div style="margin-bottom: 16px;">
    <label for="cnpj-input" style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.875rem;">CNPJ *</label>
    <input type="text" id="cnpj-input" placeholder="00.000.000/0000-00" maxlength="18"
           style="width: 100%; padding: 12px 16px; border: 1px solid #d1d5db; border-radius: 12px; font-size: 1rem; box-sizing: border-box;">
    <p id="cnpj-status" style="margin: 6px 0 0 0; font-size: 0.8125rem;"></p>
  </div>

  <input type="hidden" name="razao_social" id="razao-social-hidden">
  <input type="hidden" name="nome_fantasia" id="nome-fantasia-hidden">
  <input type="hidden" name="municipio" id="municipio-hidden">

  <div style="margin-bottom: 16px;">
    <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.875rem;">Razão social</label>
    <input type="text" id="razao-social" readonly
           style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 12px; background: #f9fafb; font-size: 1rem; box-sizing: border-box;">
  </div>
  <div style="margin-bottom: 16px;">
    <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.875rem;">Nome fantasia</label>
    <input type="text" id="nome-fantasia" readonly
           style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 12px; background: #f9fafb; font-size: 1rem; box-sizing: border-box;">
  </div>
  <div style="margin-bottom: 16px;">
    <label style="display: block; font-weight: 600; margin-bottom: 6px; font-size: 0.875rem;">Cidade</label>
    <input type="text" id="municipio" readonly
           style="width: 100%; padding: 12px 16px; border: 1px solid #e5e7eb; border-radius: 12px; background: #f9fafb; font-size: 1rem; box-sizing: border-box;">
  </div>
</div>

<script>
(function() {
  var API_CNPJ = '/api/consulta-cnpj';
  var input = document.getElementById('cnpj-input');
  var status = document.getElementById('cnpj-status');
  var razaoEl = document.getElementById('razao-social');
  var fantasiaEl = document.getElementById('nome-fantasia');
  var municipioEl = document.getElementById('municipio');
  var razaoHidden = document.getElementById('razao-social-hidden');
  var fantasiaHidden = document.getElementById('nome-fantasia-hidden');
  var municipioHidden = document.getElementById('municipio-hidden');

  function formatCNPJ(v) {
    var d = (v || '').replace(/\D/g, '').slice(0, 14);
    if (d.length <= 2) return d;
    if (d.length <= 5) return d.slice(0,2) + '.' + d.slice(2);
    if (d.length <= 8) return d.slice(0,2) + '.' + d.slice(2,5) + '.' + d.slice(5);
    if (d.length <= 12) return d.slice(0,2) + '.' + d.slice(2,5) + '.' + d.slice(5,8) + '/' + d.slice(8);
    return d.slice(0,2) + '.' + d.slice(2,5) + '.' + d.slice(5,8) + '/' + d.slice(8,12) + '-' + d.slice(12);
  }

  function validarCNPJ(cnpj) {
    var digits = (cnpj || '').replace(/\D/g, '');
    if (digits.length !== 14 || /^(\d)\1{13}$/.test(digits)) return false;
    var peso1 = [5,4,3,2,9,8,7,6,5,4,3,2], peso2 = [6,5,4,3,2,9,8,7,6,5,4,3,2];
    var soma = 0, i;
    for (i = 0; i < 12; i++) soma += parseInt(digits[i]) * peso1[i];
    var r = soma % 11, d1 = r < 2 ? 0 : 11 - r;
    if (d1 !== parseInt(digits[12])) return false;
    soma = 0;
    for (i = 0; i < 13; i++) soma += parseInt(digits[i]) * peso2[i];
    r = soma % 11; var d2 = r < 2 ? 0 : 11 - r;
    return d2 === parseInt(digits[13]);
  }

  function setFields(razao, fantasia, municipio) {
    razaoEl.value = razao || '';
    fantasiaEl.value = fantasia || '';
    municipioEl.value = municipio || '';
    razaoHidden.value = razao || '';
    fantasiaHidden.value = fantasia || '';
    municipioHidden.value = municipio || '';
  }

  function consultar(digits) {
    if (digits.length !== 14 || !validarCNPJ(digits)) return;
    status.textContent = 'Consultando...';
    status.style.color = '#b45309';
    setFields('', '', '');
    fetch(API_CNPJ + '?cnpj=' + encodeURIComponent(digits))
      .then(function(r) { return r.json(); })
      .then(function(data) {
        if (data.error) {
          status.textContent = data.error;
          status.style.color = '#dc2626';
          return;
        }
        status.textContent = '';
        setFields(data.razao_social || '', data.nome_fantasia || '', data.municipio || '');
      })
      .catch(function() {
        status.textContent = 'Erro de conexão';
        status.style.color = '#dc2626';
        setFields('', '', '');
      });
  }

  function onInput() {
    var raw = input.value.replace(/\D/g, '').slice(0, 14);
    input.value = formatCNPJ(raw);
    status.textContent = '';
    if (raw.length === 14 && validarCNPJ(raw)) consultar(raw);
    else setFields('', '', '');
  }

  input.addEventListener('input', onInput);
  input.addEventListener('paste', function(e) {
    e.preventDefault();
    var pasted = (e.clipboardData.getData('text') || '').replace(/\D/g, '').slice(0, 14);
    input.value = formatCNPJ(pasted);
    status.textContent = '';
    if (pasted.length === 14 && validarCNPJ(pasted)) consultar(pasted);
    else setFields('', '', '');
  });
  input.addEventListener('blur', function() {
    var digits = input.value.replace(/\D/g, '');
    if (digits.length === 14 && validarCNPJ(input.value)) consultar(digits);
  });
})();
</script>
